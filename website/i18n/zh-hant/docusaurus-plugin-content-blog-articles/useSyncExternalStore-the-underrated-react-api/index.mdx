---
slug: useSyncExternalStore-the-underrated-react-api
title: useSyncExternalStore - The underrated React API
authors: [slorber]
date: 2022-09-06
twitterThreadUrl: "https://slo.im/t/articles/useSyncExternalStore"
image: ./social-card.png
---

# useSyncExternalStore - è¢«ä½ä¼°çš„ React API

ä½ å¯èƒ½è½é [`useSyncExternalStore()`](https://reactjs.org/docs/hooks-reference.html#usesyncexternalstore)ï¼Œé€™æ˜¯ React 18 çš„æ–°é‰¤å­ï¼Œç”¨æ–¼**è¨‚é–±å¤–éƒ¨è³‡æ–™ä¾†æº**ã€‚å®ƒå¸¸è¢«ç‹€æ…‹ç®¡ç†å‡½å¼åº«ï¼ˆå¦‚ [Redux](https://github.com/reduxjs/react-redux/pull/1808)ï¼‰å…§éƒ¨ä½¿ç”¨ï¼Œä»¥å¯¦ç¾**é¸æ“‡å™¨ç³»çµ±**ã€‚

ä½†åœ¨ä½ è‡ªå·±çš„æ‡‰ç”¨ç¨‹å¼ç¢¼ä¸­ä½¿ç”¨ `useSyncExternalStore()` åˆå¦‚ä½•å‘¢ï¼Ÿ

åœ¨é€™ç¯‡äº’å‹•å¼æ–‡ç« ä¸­ï¼Œæˆ‘æƒ³æå‡ºä¸€å€‹å•é¡Œï¼š**éåº¦å›å‚³çš„ React é‰¤å­è§¸ç™¼äº†ç„¡ç”¨çš„é‡æ–°æ¸²æŸ“**ã€‚æˆ‘å€‘å°‡æ¢è¨ `useSyncExternalStore()` å¦‚ä½•æˆç‚ºä¸€å€‹å¥½çš„è§£æ±ºæ–¹æ¡ˆã€‚

![ç¤¾äº¤å¡ç‰‡](./social-card.png)

<!-- truncate -->

<SubscribeFormEmbed />

import {
  App,
  AppFixed,
  ScrollApp,
} from "@site/articles/useSyncExternalStore-the-underrated-react-api/demos";

## éåº¦å›å‚³çš„é‰¤å­

è®“æˆ‘å€‘ç”¨ React-Router çš„ [`useLocation()`](https://reactrouter.com/en/main/hooks/use-location) ä¾†èªªæ˜é€™å€‹å•é¡Œã€‚

é€™å€‹é‰¤å­å›å‚³åŒ…å«å¤šå€‹å±¬æ€§ï¼ˆ`pathname`ã€`hash`ã€`search`...ï¼‰çš„ç‰©ä»¶ï¼Œä½†ä½ å¯èƒ½ä¸æœƒè®€å–å…¨éƒ¨å±¬æ€§ã€‚åƒ…åƒ…èª¿ç”¨è©²é‰¤å­å°±æœƒåœ¨ä»»ä¸€å±¬æ€§æ›´æ–°æ™‚è§¸ç™¼é‡æ–°æ¸²æŸ“ã€‚

è€ƒæ…®ä»¥ä¸‹æ‡‰ç”¨ç¨‹å¼ï¼š

```tsx
function CurrentPathname() {
  const { pathname } = useLocation();
  return <div>{pathname}</div>;
}

function CurrentHash() {
  const { hash } = useLocation();
  return <div>{hash}</div>;
}

function Links() {
  return (
    <div>
      <Link to="#link1">#link1</Link>
      <Link to="#link2">#link2</Link>
      <Link to="#link3">#link3</Link>
    </div>
  );
}

function App() {
  return (
    <div>
      <CurrentPathname />
      <CurrentHash />
      <Links />
    </div>
  );
}
```

<App />

é»æ“Šä»»ä½•é›œæ¹Šé€£çµæ™‚ï¼Œ`CurrentPathname` å…ƒä»¶éƒ½æœƒé‡æ–°æ¸²æŸ“ï¼Œå³ä½¿å®ƒæ ¹æœ¬æ²’æœ‰ä½¿ç”¨ `hash` å±¬æ€§ ğŸ˜…ã€‚

:::tip

ç•¶ä¸€å€‹é‰¤å­å›å‚³äº†ä½ æœªé¡¯ç¤ºçš„è³‡æ–™æ™‚ï¼Œè«‹æ€è€ƒ React é‡æ–°æ¸²æŸ“çš„å•é¡Œã€‚å¦‚æœä¸æ³¨æ„ï¼Œåœ¨ React æ¨¹é ‚å±¤æ·»åŠ çš„ä¸€å€‹å°å° `useLocation()` èª¿ç”¨å°±å¯èƒ½æå®³æ‡‰ç”¨ç¨‹å¼æ•ˆèƒ½ã€‚

:::

:::info

ç›®æ¨™ä¸¦éæ‰¹è©• React-Routerï¼Œè€Œæ˜¯èªªæ˜å•é¡Œã€‚`useLocation()` åªæ˜¯å‰µå»ºé€™ç¯‡äº’å‹•å¼æ–‡ç« çš„å¯¦ç”¨æ¡ˆä¾‹ã€‚ä½ è‡ªå·±çš„ React é‰¤å­å’Œå…¶ä»–ç¬¬ä¸‰æ–¹å‡½å¼åº«ä¹Ÿå¯èƒ½éåº¦å›å‚³ã€‚

:::

## `useSyncExternalStore` ä¾†æ•‘æ´ï¼Ÿ

[å®˜æ–¹æ–‡ä»¶](https://reactjs.org/docs/hooks-reference.html#usesyncexternalstore)æŒ‡å‡ºï¼š

> useSyncExternalStore æ˜¯ä¸€å€‹æ¨è–¦ç”¨æ–¼è®€å–å’Œè¨‚é–±å¤–éƒ¨è³‡æ–™ä¾†æºçš„é‰¤å­ï¼Œå…¶æ–¹å¼å…¼å®¹ä¸¦ç™¼æ¸²æŸ“åŠŸèƒ½ï¼ˆå¦‚é¸æ“‡æ€§æ°´åˆå’Œæ™‚é–“åˆ‡ç‰‡ï¼‰ã€‚
> æ­¤æ–¹æ³•å›å‚³å„²å­˜çš„å€¼ä¸¦æ¥å—ä¸‰å€‹åƒæ•¸ï¼š
>
> - `subscribe`ï¼šè¨»å†Šå›èª¿å‡½å¼çš„å‡½å¼ï¼Œç•¶å„²å­˜è®Šæ›´æ™‚èª¿ç”¨ã€‚
> - `getSnapshot`ï¼šå›å‚³ç•¶å‰å„²å­˜å€¼çš„å‡½å¼ã€‚
> - `getServerSnapshot`ï¼šå›å‚³ä¼ºæœå™¨æ¸²æŸ“æœŸé–“ä½¿ç”¨çš„å¿«ç…§çš„å‡½å¼ã€‚

```tsx
function useSyncExternalStore<Snapshot>(
  subscribe: (onStoreChange: () => void) => () => void,
  getSnapshot: () => Snapshot,
  getServerSnapshot?: () => Snapshot,
): Snapshot;
```

é€™è½èµ·ä¾†æœ‰äº›æŠ½è±¡ã€‚é€™ç¯‡[æ¸¬è©¦ç‰ˆæ–‡ä»¶é é¢](https://beta.reactjs.org/learn/you-might-not-need-an-effect#subscribing-to-an-external-store)æä¾›äº†å¾ˆå¥½çš„ç¯„ä¾‹ï¼š

```tsx
function subscribe(callback) {
  window.addEventListener("online", callback);
  window.addEventListener("offline", callback);
  return () => {
    window.removeEventListener("online", callback);
    window.removeEventListener("offline", callback);
  };
}

function useOnlineStatus() {
  return useSyncExternalStore(
    subscribe,
    () => navigator.onLine,
    () => true,
  );
}

function ChatIndicator() {
  const isOnline = useOnlineStatus();
  // ...
}
```

äº‹å¯¦ä¸Šï¼Œç€è¦½å™¨æ­·å²ç´€éŒ„ä¹Ÿå¯è¦–ç‚ºå¤–éƒ¨è³‡æ–™ä¾†æºã€‚è®“æˆ‘å€‘çœ‹çœ‹å¦‚ä½•æ­é… React-Router ä½¿ç”¨ `useSyncExternalStore`ï¼

## å¯¦ä½œ `useHistorySelector()`

React-Router æä¾›äº†æˆ‘å€‘é€£æ¥ `useSyncExternalStore` æ‰€éœ€çš„ä¸€åˆ‡ï¼š

- é€é [`useHistory()`](https://v5.reactrouter.com/web/api/Hooks/usehistory) å­˜å–ç€è¦½å™¨æ­·å²ç´€éŒ„
- é€é [`history.listen(callback)`](https://github.com/remix-run/history/blob/main/docs/api-reference.md#history.listen) è¨‚é–±æ­·å²ç´€éŒ„æ›´æ–°
- é€é [`history.location`](https://github.com/remix-run/history/blob/main/docs/api-reference.md#historylocation) å­˜å–ç•¶å‰ä½ç½®çš„å¿«ç…§

:::caution

æœ¬ç¶²ç«™ä½¿ç”¨çš„æ˜¯ React-Router v5ï¼šè§£æ±ºæ–¹æ¡ˆåœ¨ React-Router v6 ä¸­æœƒæœ‰æ‰€ä¸åŒï¼ˆ[è©³è¦‹](https://twitter.com/Zh0uzi/status/1567523679604539405)ï¼‰ã€‚

:::

`useHistorySelector()` çš„å¯¦ä½œç›¸å°ç°¡å–®ï¼š

```tsx
function useHistorySelector(selector) {
  const history = useHistory();
  return useSyncExternalStore(history.listen, () =>
    selector(history),
  );
}
```

è®“æˆ‘å€‘åœ¨æ‡‰ç”¨ç¨‹å¼ä¸­ä½¿ç”¨å®ƒï¼š

```tsx
function CurrentPathname() {
  const pathname = useHistorySelector(
    (history) => history.location.pathname,
  );
  return <div>{pathname}</div>;
}

function CurrentHash() {
  const hash = useHistorySelector(
    (history) => history.location.hash,
  );
  return <div>{hash}</div>;
}
```

<AppFixed />

ç¾åœ¨ï¼Œç•¶ä½ é»æ“Šä¸Šæ–¹çš„ hash é€£çµæ™‚ï¼Œ`CurrentPathname` å…ƒä»¶å°‡**ä¸å†é‡æ–°æ¸²æŸ“**ï¼

## å¦ä¸€å€‹ä¾‹å­ï¼š`scrollY`

æœ‰è¨±å¤šå¤–éƒ¨è³‡æ–™ä¾†æºå¯ä¾›è¨‚é–±ï¼Œå¯¦ä½œè‡ªå·±çš„é¸æ“‡å™¨ç³»çµ±å¯ä»¥å¹«åŠ©ä½ å„ªåŒ– React çš„é‡æ–°æ¸²æŸ“ã€‚

ä¾‹å¦‚ï¼Œå‡è¨­æˆ‘å€‘æƒ³è¦ä½¿ç”¨é é¢çš„ `scrollY` ä½ç½®ã€‚æˆ‘å€‘å¯ä»¥å¯¦ä½œé€™å€‹è‡ªè¨‚ React hookï¼š

```tsx
// A memoized constant fn prevents unsubscribe/resubscribe
// In practice it is not a big deal
function subscribe(onStoreChange) {
  global.window?.addEventListener("scroll", onStoreChange);
  return () =>
    global.window?.removeEventListener(
      "scroll",
      onStoreChange,
    );
}

function useScrollY(selector = (id) => id) {
  return useSyncExternalStore(
    subscribe,
    () => selector(global.window?.scrollY),
    () => undefined,
  );
}
```

æˆ‘å€‘ç¾åœ¨å¯ä»¥ä½¿ç”¨é€™å€‹ hookï¼Œä¸¦æ­é…ä¸€å€‹å¯é¸çš„é¸æ“‡å™¨ï¼š

```tsx
function ScrollY() {
  const scrollY = useScrollY();
  return <div>{scrollY}</div>;
}

function ScrollYFloored() {
  const to = 100;
  const scrollYFloored = useScrollY((y) =>
    y ? Math.floor(y / to) * to : undefined,
  );
  return <div>{scrollYFloored}</div>;
}
```

<ScrollApp />

æ»¾å‹•é é¢ï¼Œçœ‹çœ‹ä¸Šæ–¹å…ƒä»¶å¦‚ä½•é‡æ–°æ¸²æŸ“ï¼Ÿå…¶ä¸­ä¸€å€‹å…ƒä»¶çš„é‡æ–°æ¸²æŸ“æ¬¡æ•¸æ¯”å¦ä¸€å€‹å°‘ï¼

:::info

When you don't need a `scrollY` 1 pixel precision level, returning a wide range value such as `scrollY` can also be considered as over-returning. Consider returning a narrower value.

For example: a `useResponsiveBreakpoint()` hook that only returns a limited set of values (`small`, `medium` or `large`) will be more optimized than a `useViewportWidth()` hook.

If a React component only handles `large` screens differently, you can create an even narrower `useIsLargeScreen()` hook returning a boolean.

:::

## çµè«–

å¸Œæœ›æœ¬æ–‡èƒ½èªªæœä½ é‡æ–°å¯©è¦– `useSyncExternalStore()`ã€‚æˆ‘èªç‚ºé€™å€‹ hook ç›®å‰åœ¨ React ç”Ÿæ…‹ç³»ä¸­ä½¿ç”¨ä¸è¶³ï¼Œå€¼å¾—æ›´å¤šé—œæ³¨ï¼Œå› ç‚ºå­˜åœ¨è¨±å¤šå¯è¨‚é–±çš„å¤–éƒ¨è³‡æ–™ä¾†æºã€‚

è‹¥å°šæœªå‡ç´šè‡³ React 18ï¼Œå¯ä½¿ç”¨ npm çš„ [use-sync-external-store](https://www.npmjs.com/package/use-sync-external-store) å¢Šç‰‡å¥—ä»¶æ”¯æ´èˆŠç‰ˆæœ¬ã€‚ç•¶éœ€å›å‚³è¨˜æ†¶åŒ–çš„éåŸå§‹å€¼æ™‚ï¼Œä¹Ÿå¯ä½¿ç”¨ `use-sync-external-store/with-selector` åŒ¯å‡ºåŠŸèƒ½ã€‚